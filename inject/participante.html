<style>
    .timeline-comment-box {
        background: #f2f3f4;
        margin-left: -10px;
        margin-right: -10px;
        padding: 10px 25px
    }

    .timeline-comment-box .user {
        float: left;
        width: 34px;
        height: 34px;
        overflow: hidden;
        border-radius: 30px
    }

    .timeline-comment-box .user img {
        max-width: 100%;
        max-height: 100%
    }

    .timeline-comment-box .user+.input {
        margin-left: 44px
    }

    .comment-text {
        font-size: 12px
    }
    .textarealine {
        overflow: auto;
        width: 100%;
        resize: inline;
    }
</style>

<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/js/adminlte.min.js" integrity="sha512-AJUWwfMxFuQLv1iPZOTZX0N/jTCIrLxyZjTRKQostNU71MzZTEPHjajSK20Kj1TwJELpP7gl+ShXw5brpnKwEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/alt/adminlte.plugins.min.css" integrity="sha512-4d1AMy6HY7Xvy2mMCmesGyao+6HeuN2Nktiv8eFq4qaF8Qdn9MOCivuzLCqfuMRhOl0/ZUka90iewctDloorwg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/alt/adminlte.components.min.css" integrity="sha512-uwtD0BDaxWJ4i+PXTYZfiUKSaOTKY+bp4+c0TJZgcCGKHTpA7xp2HI2AIxkMtgOg40edi4cYS2ZjghRI14nQ0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/adminlte.min.css" integrity="sha512-mxrUXSjrxl8vm5GwafxcqTrEwO1/oBNU25l20GODsysHReZo4uhVISzAKzaABH6/tTfAxZrY2FprmeAP5UZY8A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- librerias adicionales -->
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<div class="container-fluid">
    <div class="card" id="vue-chat">

        <div class="card-header bg-success">
            <h3 class="card-title">Direct Chat</h3>
            <input type="text" class="form-control float-right" id="buscador" placeholder="Buscar">
        </div>

        <!-- /.card-header -->
        <div class="card-body" >
            <!-- Conversations are loaded here -->
            <div class="direct-chat-messageddds">
                <!-- Message. Default to the left -->
                <div class="container" v-for="mens in mensajes" v-if="mens.visible">
                    <div class="direct-chat-msg">
                        <div class="direct-chat-infos clearfix">
                            <span class="direct-chat-name float-left">
                        
                            </span>
                            <span class="direct-chat-timestamp float-right"> 
                                <i class="far fa-clock"></i> <br>
                                <i class='far fa-clock'></i>
                            </span>
                    </div>
                    <!-- /.direct-chat-infos -->
                    <img class="direct-chat-img" src="https://bootdey.com/img/Content/avatar/avatar6.png" alt="message user image">
                    <!-- /.direct-chat-img -->
                    <div class="direct-chat-text" style="background-color:#f2f3f4">

                    <div class = "header">
                        <h4> {{mens.titulo_mensaje}} </h4> 
                        <span>{{mens.titulo_tarea}}</span>
                        <div> 
                            <hr>
                                {{mens.mensaje}}
                            <hr>
                            <div class="timeline-footer">
                                <a href="javascript:;" class="m-r-15 text-inverse-lighter">
                                    <i class="fa fa-thumbs-up fa-fw fa-lg m-r-3"></i> Like
                                </a>
                                <a class="m-r-15 text-inverse-lighter" title="" data-caption="Enviar" href="/homesimex/Email2Add?Idrenviar=71" data-original-title="Enviar">
                                    Reenviar&nbsp;<i class="fas fa-sign-out-alt"></i> 
                                </a>
                                <a href="javascript:;" class="m-r-15 text-inverse-lighter">
                                    <i class="fa fa-comments fa-fw fa-lg m-r-3"></i> Comment
                                </a> 
                                <a type="button" class="m-r-15 text-inverse-lighter" data-toggle="collapse" v-bind:href="'#collapse'+mens.id" >
                                    <i class="fa fa-comments fa-fw fa-lg m-r-3"></i> Comment
                                </a> 
                            </div>
            
                            <div class="collapse" v-bind:id="'collapse'+mens.id">
                                <div class="timeline-comment-box">
                                    <div class="user">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar6.png">
                                    </div>
                                    <div class="input">
                                        <div class="input-group">
                                            <textarea type="text" class="textarealine" v-model="mens.entrada"></textarea>
                                        </div>
                                        <div class="mt-2 text-right">
                                            <button class="btn btn-primary btn-sm shadow-none" v-on:click="hacerComentario(mens)" type="button">Envio
                                        </div>
                                        <hr>       
                                        <div v-for="coment in mens.comentarios">   
                                            <span>
                                                <em> {{coment.nombre}} </em>
                                            </span>
                                            <span class="float-right">
                                                {{coment.hora}}
                                            </span>
                                                

                                            <div class="timeline-content">  
                                                <p class="comment-text" >
                                                    <small>{{coment.texto}}</small>
                                                </p>
                                            </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>     
        </div>
    </div>
</div>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.js"></script>
<script src="pubnub.js"></script>
  
<script type="text/javascript">
    var app = new Vue({
        el: '#vue-chat',
        data: {
            mensajes: []
        },
        methods:{
            hacerComentario: function(mensaje){
                if(mensaje.entrada == ""){
                    return;
                }
                $.ajax({
                    url: "http://localhost/fakeUrls/guardar_comentario.php",
                    type: "POST",
                    data: {
                        "idMensaje":mensaje.id,
                        "idUser":1,
                        "comentario":mensaje.entrada
                    },
                    success: function (es) {
                        let respuesta = JSON.parse(es)[0];
                        pubnub.enviarMensaje({
                            "id":respuesta.id
                        });
                        
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
                mensaje.entrada = "";
            }
        }
    });

    var publishKey = 'pub-c-5260e585-8e9b-4d60-9ff8-1d10154850f4';
    var subscribeKey = 'sub-c-69a803ce-dbfd-11eb-85de-ba1258ebcf9d';

    var pubnub = new CanalPub("canal-01",publishKey,subscribeKey);
    var pubnubAdmin = new CanalPub("canal-02",publishKey,subscribeKey);
    pubnub.mensajeLlegado = llegadaComentario;
    pubnubAdmin.mensajeLlegado = llegandoMensaje;

    function llegadaComentario(msg){
        let comentario = msg.message;
        console.log(comentario);
        $.ajax({
            url: "http://localhost/fakeUrls/comentario.php?idComentario="+comentario.id,
            success: function (es) {
                let respuesta = JSON.parse(es)[0];
                for(let i = 0;i < app.mensajes.length;i++){
                    if(app.mensajes[i].id == respuesta.idMensaje){
                        let add = {
                            "nombre":respuesta.nombre,
                            "hora":respuesta.hora,
                            "texto":respuesta.mensaje
                        };
                        app.mensajes[i].comentarios.push(add);
                    }
                }
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

    function obtenerComentariosVarios(comentarios,id){
        $.ajax({
            url: "http://localhost/fakeUrls/obtener_comentarios.php?idMensaje="+id,
            success: function (es) {
                let respuesta = JSON.parse(es);
                for(let i = 0;i < respuesta.length;i++){
                    let res = respuesta[i];
                    let add = {
                        "nombre":res.nombre,
                        "hora":res.hora,
                        "texto":res.mensaje
                    };
                    comentarios.push(add);
                }
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

    function llegandoMensaje(msg){
        let code = msg.message.code;
        $.ajax({
            url: "http://localhost/fakeUrls/pedir_mensaje.php?idMensaje="+code,
            success: function (es) {
                let ayuda = JSON.parse(es);
                if(ayuda.length == 0){
                    return;
                }
                let respuesta = ayuda[0];
                respuesta.numero_comentarios = 0;
                respuesta.comentarios = [];
                respuesta.entrada = "";
                respuesta.visible = true;
                app.mensajes.push(respuesta);
                obtenerComentariosVarios(respuesta.comentarios,respuesta.id);
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

    function mensajeFalso1(){
        let mensaje = {
            "avatar":"https://pm1.narvii.com/7039/3430a5f90fb2d55871c979b14d9792cb6618b627r1-1184-698v2_hq.jpg",
            "titulo_mensaje":"Titulo Random",
            "titulo_tarea":"tarea random",
            "mensaje":"es de conocimienco comun que el fuego quema",
            "entrada":"",
            "id":4,
            "comentarios":[
                {"nombre":"Juan Perez","hora":"12:55 AM","texto":"que calor que hace aqui"},
                {"nombre":"Rodrigo Perales","hora":"13:05 PM","texto":"concuerdo"}
            ]
        };
        app.mensajes.push(mensaje);
    }

    function mensajeFalso2(){
        let mensaje = {
            "avatar":"https://images.heb.com/is/image/HEBGrocery/000402266?fit=constrain,1&wid=800&hei=800&fmt=jpg&qlt=85,0&resMode=sharp2&op_usm=1.75,0.3,2,0",
            "titulo_mensaje":"Consume Gansito",
            "titulo_tarea":"mejor opcion",
            "mensaje":"el mejor precio junto con la mejor opcion",
            "entrada":"",
            "id":8,
            "comentarios":[
                {"nombre":"Maria Lino","hora":"13:55 AM","texto":"alquien esta por ahi"},
                {"nombre":"Juan Perez","hora":"12:20 AM","texto":"como es la cosa aqui"},
                {"nombre":"Pedro Suarez","hora":"11:03 AM","texto":"me dices la verdad?"}
            ]
        };
        app.mensajes.push(mensaje);
        
    }
    function mensajeFalso3(){
        let mensaje = {
            "avatar":"https://images.heb.com/is/image/HEBGrocery/000402266?fit=constrain,1&wid=800&hei=800&fmt=jpg&qlt=85,0&resMode=sharp2&op_usm=1.75,0.3,2,0",
            "titulo_mensaje":"Consume Gansito",
            "titulo_tarea":"mejor opcion",
            "mensaje":"el mejor precio junto con la mejor opcion",
            "entrada":"",
            "id":7,
            "comentarios":[
                {"nombre":"Esteban Quito","hora":"09:55 AM","texto":"un patito color de cafe aparece"},
            ]
        };
        app.mensajes.push(mensaje);
    }

    function obtenerMensajesEnviados(){
        $.ajax({
            url: "http://localhost/fakeUrls/enviados.php",
            success: function (es) {
                let respuesta = JSON.parse(es);
                console.log(respuesta);
                for(let i = 0;i < respuesta.length;i++){
                    let mens = respuesta[i];
                    mens.numero_comentarios = 0;
                    mens.comentarios = [];
                    mens.entrada = "";
                    mens.visible = true;
                    app.mensajes.push(mens);
                    obtenerComentariosVarios(mens.comentarios,mens.id);
                }
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

    $(document).ready(function(){
        $("#buscador").on('keyup', function() {
            let val = $("#buscador").val();
            for(let i = 0;i < app.mensajes.length;i++){
                let mens = app.mensajes[i];
                mens.visible = false;
                if(mens.titulo_mensaje.toLowerCase().includes(val.toLowerCase())){
                    mens.visible = true;
                }
                if(mens.titulo_tarea.toLowerCase().includes(val.toLowerCase())){
                    mens.visible = true;
                }
                if(mens.mensaje.toLowerCase().includes(val.toLowerCase())){
                    mens.visible = true;
                }
            }
        });
        obtenerMensajesEnviados();
    });
</script>